<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Multi-Role Career Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        .card { background-color: white; border-radius: 1rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .progress-bar { transition: width 0.5s ease-in-out; }
        .nav-tab {
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }
        .nav-tab.active {
            border-color: #4f46e5;
            color: #4f46e5;
            font-weight: 600;
        }
        .category-button {
            transition: all 0.2s;
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .category-button.active {
            background-color: #4f46e5;
            color: white;
            box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.3);
        }
        .sub-nav-tab {
            @apply px-3 py-1 text-sm rounded-full transition duration-150;
        }
        .sub-nav-tab.active {
            @apply bg-indigo-500 text-white shadow;
        }
    </style>
</head>
<body class="p-4 sm:p-8 min-h-screen">

    <!-- Main Container -->
    <div class="max-w-6xl mx-auto">
        <header class="text-center mb-6">
            <h1 class="text-4xl font-extrabold text-indigo-700">AI Multi-Role Career Tracker</h1>
            <p class="text-lg text-gray-500 mt-2">Generate, organize, and track your professional goals across multiple paths.</p>
            <div id="user-info" class="text-sm text-gray-400 mt-2"></div>
        </header>

        <!-- Navigation Tabs -->
        <div class="bg-white card p-2 mb-8 shadow-lg sticky top-0 z-10">
            <div class="flex justify-around text-gray-500">
                <button class="nav-tab py-2 px-4 active" data-page="roles">Roles</button>
                <button class="nav-tab py-2 px-4" data-page="preparation">Preparation</button>
                <button class="nav-tab py-2 px-4" data-page="skills">Skills & Tracker</button>
                <button class="nav-tab py-2 px-4" data-page="metrics">Metrics</button>
            </div>
        </div>

        <!-- Main Content Area -->
        <div id="content-area">

            <!-- 1. Roles Page (Role Selection & Tracking) -->
            <div id="roles-page" class="page-content">
                <div class="card p-6 mb-8 border-t-4 border-indigo-500">
                    <h2 class="text-2xl font-bold mb-4 text-gray-800">1. Select or Define Your Role</h2>

                    <!-- Category Segmentation -->
                    <div id="role-categories" class="flex flex-wrap mb-4">
                        <button class="category-button bg-indigo-100 text-indigo-700 active" data-category="Tech">Tech</button>
                        <button class="category-button bg-gray-100 text-gray-700" data-category="Pure Code">Pure Code</button>
                        <button class="category-button bg-gray-100 text-gray-700" data-category="Analyst">Analyst</button>
                        <button class="category-button bg-gray-100 text-gray-700" data-category="Consultant">Consultant</button>
                        <button class="category-button bg-gray-100 text-gray-700" data-category="No Code/Low Code">No Code/Low Code</button>
                        <button class="category-button bg-gray-100 text-gray-700" data-category="Non-Tech">Non-Tech</button>
                    </div>

                    <!-- Role Selection Lists -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                        <div class="w-full">
                            <label for="role-select" class="block text-sm font-medium text-gray-700 mb-1">Select from Popular Roles:</label>
                            <select id="role-select" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm transition duration-150 ease-in-out bg-white">
                                <!-- Options populated by JS based on category -->
                            </select>
                        </div>
                        <div class="w-full">
                            <label for="new-role-input" class="block text-sm font-medium text-gray-700 mb-1">...or Enter a New Role:</label>
                            <input type="text" id="new-role-input" placeholder="Enter custom role to generate unique plan" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm transition duration-150 ease-in-out">
                        </div>
                    </div>

                    <!-- Manual JD Input -->
                    <div>
                        <label for="manual-jd-input" class="block text-sm font-medium text-gray-700 mb-1">
                            Optional: Paste a Job Description (JD) for hyper-accurate planning:
                        </label>
                        <textarea id="manual-jd-input" rows="4" placeholder="Paste the full job description here (e.g., from LinkedIn or a company site)." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm transition duration-150 ease-in-out"></textarea>
                    </div>

                    <button id="generate-btn" disabled class="w-full px-6 py-3 text-lg font-semibold text-white bg-indigo-500 hover:bg-indigo-600 rounded-lg transition duration-200 ease-in-out disabled:bg-indigo-300 disabled:cursor-not-allowed mt-4">
                        Generate Checklists for Role
                    </button>
                </div>
                
                <div id="tracked-roles-list" class="card p-6 hidden">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800">Tracked Roles (<span id="tracked-roles-count">0</span>)</h3>
                    <div id="roles-status-container" class="space-y-4">
                        <!-- Tracked roles status cards will be rendered here -->
                        <p id="no-roles-message" class="text-gray-500">No roles currently being tracked. Generate one above!</p>
                    </div>
                    <button id="go-to-tracker-btn" class="mt-6 px-4 py-2 bg-indigo-100 text-indigo-700 font-medium rounded-lg hover:bg-indigo-200 transition">View Consolidated Tracker</button>
                </div>

                <div id="loading-indicator" class="hidden text-center p-10">
                    <svg class="animate-spin h-8 w-8 text-indigo-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="text-indigo-500 mt-3">Generating learning path and preparation steps with AI...</p>
                </div>
            </div>

            <!-- 2. Preparation Page (Interactive Hierarchy) -->
            <div id="preparation-page" class="page-content hidden">
                <div class="card p-6 border-t-4 border-indigo-500">
                    <h2 class="text-2xl font-bold mb-4 text-gray-800 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 mr-2 text-indigo-600">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 17.07c-.12.1-.256.176-.402.215l-1.745.426c-.328.081-.66.027-.92-.12a1.944 1.944 0 01-.19-.19l-.532-.532a1.944 1.944 0 01-.12-.92l.426-1.745c.039-.146.115-.282.215-.402L16.862 4.487z" />
                        </svg>
                        Job Readiness & Interview Hierarchy
                    </h2>
                    <p class="text-gray-600 mb-6">Structured preparation steps and interview rounds for your tracked roles.</p>

                    <div id="preparation-container" class="space-y-6">
                        <p id="prep-placeholder" class="text-center text-gray-500 py-10">
                            No active roles with preparation data. Please generate a role plan on the **Roles** tab.
                        </p>
                        <!-- Preparation cards for each role will be rendered here -->
                    </div>
                </div>
            </div>

            <!-- 3. Skills Page (Collective and Role-Specific Checklists) -->
            <div id="skills-page" class="page-content hidden space-y-8">
                <div class="card p-4">
                    <div id="skills-sub-nav" class="flex flex-wrap gap-2 justify-center">
                        <button class="sub-nav-tab active" data-view="collective">Collective Skills (All Roles)</button>
                        <!-- Role-specific buttons will be rendered here -->
                    </div>
                </div>

                <!-- Collective Skills View -->
                <div id="collective-skills-view" class="skills-view space-y-8">
                    <div id="collective-skills-container" class="card p-6">
                        <h3 class="text-xl font-semibold mb-4 text-indigo-700 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 mr-2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                            </svg>
                            Consolidated Skill Map
                        </h3>
                        <p class="text-sm text-gray-500 mb-4">View unique skills required across all your tracked roles. Checking a skill here marks it as complete for ALL related roles.</p>
                        <div id="collective-skills-list" class="space-y-4">
                            <p class="text-center text-gray-500 py-4">Tracked skills will appear here once roles are generated.</p>
                        </div>
                    </div>
                </div>

                <!-- Individual Role View Containers (Initially Hidden) -->
                <div id="role-checklists-views">
                    <!-- Dynamic checklists will be inserted here -->
                </div>

                <div id="skills-placeholder" class="text-center p-10 card">
                    <p class="text-gray-500">Please generate or track a role on the **Roles** tab to view your checklists.</p>
                </div>
            </div>

            <!-- 4. Metrics Page (Multi-Role Progress) -->
            <div id="metrics-page" class="page-content hidden">
                <div class="card p-6 border-t-4 border-indigo-500">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 mr-2 text-indigo-600">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125l3-3m0 0l-3-3m3 3h15.75m-3.75 3V7.5M8.25 18V7.5" />
                        </svg>
                        Career Metrics: Consolidated Progress
                    </h2>

                    <div id="metrics-content">
                        <p class="text-gray-500 text-center py-10" id="metrics-placeholder">
                            Select and generate roles on the **Roles** tab to view progress.
                        </p>
                    </div>

                    <div id="metrics-dashboard" class="hidden grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
                        
                        <!-- Total Progress -->
                        <div class="p-5 bg-indigo-50 rounded-xl shadow">
                            <div class="text-sm font-semibold text-indigo-600">Overall Completion (Weighted)</div>
                            <div id="metrics-progress-ring" class="mt-3 w-20 h-20 mx-auto relative flex items-center justify-center">
                                <svg class="w-full h-full transform -rotate-90">
                                    <circle class="text-gray-200" stroke-width="8" stroke="currentColor" fill="transparent" r="32" cx="40" cy="40"/>
                                    <circle id="progress-circle" class="text-indigo-500" stroke-width="8" stroke-dasharray="201" stroke-dashoffset="201" stroke-linecap="round" stroke="currentColor" fill="transparent" r="32" cx="40" cy="40" style="transition: stroke-dashoffset 0.5s ease-in-out;"/>
                                </svg>
                                <span id="metrics-progress-text" class="absolute text-xl font-bold text-indigo-700">0%</span>
                            </div>
                        </div>

                        <!-- Time Metrics -->
                        <div class="p-5 bg-green-50 rounded-xl shadow">
                            <div class="text-sm font-semibold text-green-600">Total Learning Commitment</div>
                            <div id="metrics-total-time" class="text-3xl font-extrabold mt-1 text-green-700">0 hrs</div>
                            <div class="text-xs text-gray-500 mt-2">Sum of all estimated effort across roles.</div>
                        </div>

                        <!-- Items Completed -->
                        <div class="p-5 bg-red-50 rounded-xl shadow">
                            <div class="text-sm font-semibold text-red-600">Total Items Completed</div>
                            <div id="metrics-completed-items" class="text-3xl font-extrabold mt-1 text-red-700">0 / 0</div>
                            <div class="text-xs text-gray-500 mt-2">Skills and projects checked off across all roles.</div>
                        </div>
                    </div>
                    
                    <h3 class="text-xl font-bold mt-8 mb-4 text-gray-800 border-b pb-2">Role Breakdown</h3>
                    <div id="metrics-role-breakdown" class="space-y-4">
                        <p id="breakdown-placeholder" class="text-gray-500">Individual role metrics will show here.</p>
                        <!-- Individual role progress bars will be inserted here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Custom Alert/Modal for errors -->
        <div id="custom-alert" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center p-4 z-50">
            <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full">
                <h3 class="text-lg font-bold text-red-600 mb-3">Error</h3>
                <p id="alert-message" class="text-gray-700 mb-4"></p>
                <button onclick="document.getElementById('custom-alert').classList.add('hidden')" class="w-full px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition">Close</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK Imports and Initialization -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, getDoc, collection, query, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL SETUP & FIREBASE INIT ---
        setLogLevel('debug');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let userId = null;
        let trackedRolesData = {}; // Stores all role data: { 'role-name': { ...data } }
        let isAuthReady = false;
        let activeCategory = 'Tech'; // Default active category for roles page
        let activeSkillsView = 'collective'; // Default view for skills page

        // Role data mapping for segmented selection
        const roleData = {
            'Tech': [
                'Software Engineer', 'Data Scientist', 'Cloud Architect', 'DevOps Specialist', 'Machine Learning Engineer'
            ],
            'Pure Code': [
                'Backend Developer (Go)', 'Frontend Developer (React)', 'Full Stack Developer', 'Game Developer (Unity)', 'Embedded Systems Engineer'
            ],
            'Analyst': [
                'Financial Analyst', 'Business Analyst', 'Data Analyst', 'Market Research Analyst', 'Operations Analyst'
            ],
            'Consultant': [
                'Strategy Consultant', 'IT Consultant', 'Management Consultant', 'HR Consultant', 'Cybersecurity Consultant'
            ],
            'No Code/Low Code': [
                'Salesforce Administrator', 'Power Platform Developer', 'Bubble App Builder', 'Webflow Designer', 'Process Automation Specialist'
            ],
            'Non-Tech': [
                'Technical Writer', 'Product Manager', 'UX Designer', 'Marketing Manager', 'Recruiter'
            ]
        };

        if (firebaseConfig) {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            onAuthStateChanged(auth, async (user) => {
                if (!user) {
                    if (initialAuthToken) {
                        try {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } catch (e) {
                            console.error("Custom token sign-in failed. Falling back to anonymous.", e);
                            await signInAnonymously(auth);
                        }
                    } else {
                         await signInAnonymously(auth);
                    }
                }
                userId = auth.currentUser?.uid || crypto.randomUUID();
                document.getElementById('user-info').textContent = `User ID: ${userId} (Authenticated)`;
                isAuthReady = true;
                
                // Start listening to ALL tracked roles for the user
                subscribeToAllRoles();
            });
        } else {
            console.error("Firebase configuration not found. Persistence will not work.");
            document.getElementById('user-info').textContent = 'Warning: Persistence disabled (No Firebase Config)';
        }
        
        // --- DOM ELEMENTS & NAV SETUP ---
        const pageContents = document.querySelectorAll('.page-content');
        const navTabs = document.querySelectorAll('.nav-tab');
        
        const roleCategoriesEl = document.getElementById('role-categories');
        const roleSelectEl = document.getElementById('role-select');
        const newRoleInputEl = document.getElementById('new-role-input');
        const manualJDInputEl = document.getElementById('manual-jd-input'); // NEW
        const generateBtn = document.getElementById('generate-btn');
        const loadingIndicator = document.getElementById('loading-indicator');

        const trackedRolesListEl = document.getElementById('tracked-roles-list');
        const rolesStatusContainerEl = document.getElementById('roles-status-container');
        const trackedRolesCountEl = document.getElementById('tracked-roles-count');
        const goToTrackerBtn = document.getElementById('go-to-tracker-btn');

        const prepContainerEl = document.getElementById('preparation-container');
        const prepPlaceholderEl = document.getElementById('prep-placeholder');

        const skillsSubNavEl = document.getElementById('skills-sub-nav');
        const collectiveSkillsViewEl = document.getElementById('collective-skills-view');
        const collectiveSkillsListEl = document.getElementById('collective-skills-list');
        const roleChecklistsViewsEl = document.getElementById('role-checklists-views');
        const skillsPlaceholderEl = document.getElementById('skills-placeholder');
        
        const metricsDashboardEl = document.getElementById('metrics-dashboard');
        const metricsPlaceholderEl = document.getElementById('metrics-placeholder');
        const metricsProgressTextEl = document.getElementById('metrics-progress-text');
        const metricsTotalTimeEl = document.getElementById('metrics-total-time');
        const metricsCompletedItemsEl = document.getElementById('metrics-completed-items');
        const progressCircleEl = document.getElementById('progress-circle');
        const metricsRoleBreakdownEl = document.getElementById('metrics-role-breakdown');

        const customAlert = document.getElementById('custom-alert');
        const alertMessage = document.getElementById('alert-message');

        // Navigation function
        function navigateTo(pageId) {
            pageContents.forEach(page => {
                page.classList.add('hidden');
                if (page.id === `${pageId}-page`) {
                    page.classList.remove('hidden');
                }
            });

            navTabs.forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.page === pageId) {
                    tab.classList.add('active');
                }
            });
            
            // Special update calls for dynamic pages
            if (pageId === 'preparation') renderPreparationPage();
            if (pageId === 'skills') renderSkillsPage();
            if (pageId === 'metrics') renderMetricsPage();
        }

        // Set up nav event listeners
        navTabs.forEach(tab => {
            tab.addEventListener('click', () => navigateTo(tab.dataset.page));
        });
        
        goToTrackerBtn.addEventListener('click', () => navigateTo('skills'));


        // --- UTILITY FUNCTIONS ---
        function showAlert(message) {
            alertMessage.textContent = message;
            customAlert.classList.remove('hidden');
            customAlert.classList.add('flex');
        }

        function showLoading(show) {
            loadingIndicator.classList.toggle('hidden', !show);
            generateBtn.disabled = show;
            generateBtn.textContent = show ? 'Generating...' : 'Generate Checklists for Role';
        }

        function slugify(text) {
            return text.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '');
        }
        
        function calculateProgress(data) {
            if (!data) return { totalTime: 0, completedTime: 0, totalItems: 0, completedItems: 0, percentage: 0 };
            
            const allItems = [...(data.skills || []), ...(data.tracker || [])];
            
            const totalItems = allItems.length;
            const completedItems = allItems.filter(item => item.completed).length;

            const totalTime = allItems.reduce((sum, item) => sum + (item.targetTimeHours || 0), 0);
            const completedTime = allItems
                .filter(item => item.completed)
                .reduce((sum, item) => sum + (item.targetTimeHours || 0), 0);
            
            const percentage = totalTime > 0 ? Math.round((completedTime / totalTime) * 100) : 0;
            
            return { totalTime, completedTime, totalItems, completedItems, percentage };
        }

        // --- FIREBASE FUNCTIONS (MULTI-ROLE FOCUS) ---
        
        /** Returns the collection reference for the user's tracked roles. */
        const getRolesCollectionRef = () => collection(db, 'artifacts', appId, 'users', userId, 'roles');
        
        /** Returns the document reference for a specific role. */
        const getRoleDocRef = (roleName) => doc(getRolesCollectionRef(), slugify(roleName));
        

        /** Subscribes to ALL roles for the current user. This is the central data source. */
        function subscribeToAllRoles() {
            if (!isAuthReady || !db || !userId) return;

            const q = query(getRolesCollectionRef());

            onSnapshot(q, (snapshot) => {
                // Clear and rebuild trackedRolesData
                trackedRolesData = {};
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    trackedRolesData[data.role] = data;
                });
                
                // Trigger full UI updates based on the new data
                renderRolesStatusPage();
                
                // If the user is viewing other pages, trigger their update functions
                const currentPageId = document.querySelector('.nav-tab.active')?.dataset.page;
                if (currentPageId === 'preparation') renderPreparationPage();
                if (currentPageId === 'skills') renderSkillsPage();
                if (currentPageId === 'metrics') renderMetricsPage();
            }, (error) => {
                console.error("Firestore error subscribing to roles:", error);
                showAlert("Error loading data from database. Check console for details.");
            });
        }
        
        /** Toggles the completion status OR updates the time for an item. */
        async function updateChecklistItem(roleName, type, itemIndex, updateField, value) {
            if (!isAuthReady || !db) return;
            const docRef = getRoleDocRef(roleName);

            try {
                const data = trackedRolesData[roleName];
                if (!data) return;

                if (data[type] && data[type][itemIndex]) {
                    // Create a mutable copy of the list
                    const updatedList = [...data[type]];
                    
                    if (updateField === 'completed') {
                        updatedList[itemIndex].completed = value;
                    } else if (updateField === 'targetTimeHours') {
                        updatedList[itemIndex].targetTimeHours = parseInt(value) || 0;
                    }

                    // Perform the update
                    await updateDoc(docRef, {
                        [type]: updatedList
                    });
                }
            } catch (error) {
                console.error("Error updating item:", error);
                showAlert("Failed to update item status/time.");
            }
        }
        
        /** Deletes a tracked role. */
        async function deleteRole(roleName) {
            if (!isAuthReady || !db) return;
            if (!confirm(`Are you sure you want to stop tracking "${roleName}"? This cannot be undone.`)) {
                return;
            }
            try {
                await deleteDoc(getRoleDocRef(roleName));
                console.log(`Role ${roleName} deleted.`);
            } catch (error) {
                 console.error("Error deleting role:", error);
                 showAlert(`Failed to delete role ${roleName}.`);
            }
        }


        // --- GEMINI API CALL ---

        /** Calls the Gemini API to generate the structured checklist and preparation steps. */
        async function generateChecklists(roleName, category, manualJD) { // Added manualJD parameter
            showLoading(true);
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const systemPrompt = "You are an expert career mentor and structured data generator. Generate a detailed, structured learning plan for the user's specified role. Output MUST be a single JSON object with all specified keys. For `skills` and `tracker`, generate 5 items each with time estimates (IN HOURS ONLY). For company lists, select 10 relevant companies and distribute them: 3 Easy, 4 Medium, 3 Hard. Ensure reference sites are highly relevant.";
            
            let userQuery = `Generate the learning plan for the role: ${roleName}, which falls under the category: ${category}.`;
            if (manualJD) {
                userQuery += `\n\nPRIORITY: Use the following Job Description (JD) as the basis for the plan, company list, and references:\n\n---\n${manualJD}\n---`;
            }

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            // NEW FIELDS
                            "roleDescription": { "type": "STRING", "description": "A concise, single-paragraph summary of the role's responsibilities." },
                            "easyCompanies": { "type": "ARRAY", "items": { "type": "STRING" }, "description": "Up to 3 easy-level companies for entry-level practice." },
                            "mediumCompanies": { "type": "ARRAY", "items": { "type": "STRING" }, "description": "Up to 4 medium-level, competitive companies." },
                            "hardCompanies": { "type": "ARRAY", "items": { "type": "STRING" }, "description": "Up to 3 hard-level, top-tier companies." },
                            "referenceSites": { 
                                "type": "ARRAY", 
                                "items": { 
                                    "type": "OBJECT", 
                                    "properties": { "name": { "type": "STRING" }, "url": { "type": "STRING" } } 
                                }, 
                                "description": "3-5 essential reference sites (e.g., specific blogs, documentation, tutorial platforms)." 
                            },
                            // EXISTING FIELDS
                            "skills": {
                                "type": "ARRAY",
                                "items": { "type": "OBJECT", "properties": { "item": { "type": "STRING" }, "targetTimeHours": { "type": "INTEGER" } } }
                            },
                            "tracker": {
                                "type": "ARRAY",
                                "items": { "type": "OBJECT", "properties": { "item": { "type": "STRING" }, "targetTimeHours": { "type": "INTEGER" } } }
                            },
                            "preparation": {
                                "type": "ARRAY",
                                "items": { "type": "OBJECT", "properties": { "step": { "type": "STRING" }, "details": { "type": "STRING" }, "priority": { "type": "INTEGER" } } }
                            }
                        },
                        required: ["skills", "tracker", "preparation", "roleDescription", "easyCompanies", "mediumCompanies", "hardCompanies", "referenceSites"]
                    }
                }
            };

            let attempts = 0;
            const maxAttempts = 3;

            while (attempts < maxAttempts) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    const jsonString = result?.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (!jsonString) throw new Error("API returned an empty or malformed JSON string.");

                    const generatedData = JSON.parse(jsonString);

                    // Add role name, category, and initial completion status to items
                    const mapData = (list) => list.map(item => ({
                        ...item,
                        targetTimeHours: item.targetTimeHours ? parseInt(item.targetTimeHours) : 0, 
                        completed: false, // Start uncompleted
                    }));

                    const finalData = {
                        role: roleName,
                        category: category,
                        skills: mapData(generatedData.skills || []),
                        tracker: mapData(generatedData.tracker || []),
                        preparation: generatedData.preparation || [],
                        
                        // NEW DATA MAPPING
                        roleDescription: generatedData.roleDescription || 'No description provided.',
                        easyCompanies: generatedData.easyCompanies || [],
                        mediumCompanies: generatedData.mediumCompanies || [],
                        hardCompanies: generatedData.hardCompanies || [],
                        referenceSites: generatedData.referenceSites || [],
                        
                        lastUpdated: new Date().toISOString(),
                        generatedByUserId: userId
                    };

                    await setDoc(getRoleDocRef(roleName), finalData);
                    console.log(`Role data for ${roleName} saved successfully.`);
                    
                    showLoading(false);
                    return; // Success, exit loop
                } catch (error) {
                    attempts++;
                    console.error(`Attempt ${attempts} failed:`, error);
                    if (attempts < maxAttempts) {
                        const delay = Math.pow(2, attempts) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        showLoading(false);
                        showAlert(`Failed to generate content after ${maxAttempts} attempts. Error: ${error.message}`);
                    }
                }
            }
        }


        // --- RENDERING HANDLERS ---
        
        /** Renders the status cards for all tracked roles on the Roles page. */
        function renderRolesStatusPage() {
            const roles = Object.keys(trackedRolesData);
            trackedRolesCountEl.textContent = roles.length;
            rolesStatusContainerEl.innerHTML = '';

            if (roles.length === 0) {
                trackedRolesListEl.classList.add('hidden');
                rolesStatusContainerEl.innerHTML = `<p id="no-roles-message" class="text-gray-500">No roles currently being tracked. Generate one above!</p>`;
                return;
            }

            trackedRolesListEl.classList.remove('hidden');

            roles.forEach(roleName => {
                const data = trackedRolesData[roleName];
                const progress = calculateProgress(data);
                
                const card = document.createElement('div');
                card.className = 'p-4 bg-indigo-50 rounded-lg border border-indigo-200 flex flex-col sm:flex-row justify-between items-start sm:items-center shadow-sm';
                
                card.innerHTML = `
                    <div class="flex-1 min-w-0 mb-3 sm:mb-0">
                        <p class="text-lg font-bold text-indigo-700 truncate">${data.role}</p>
                        <p class="text-sm text-gray-500">Category: ${data.category}</p>
                        <p class="text-md mt-1 font-semibold text-green-600">${progress.percentage}% Complete</p>
                    </div>
                    <div class="w-full sm:w-1/3 sm:ml-4">
                        <div class="bg-gray-200 rounded-full h-2.5 mb-2">
                            <div class="progress-bar bg-green-500 h-2.5 rounded-full" style="width: ${progress.percentage}%"></div>
                        </div>
                        <button data-role="${roleName}" class="view-role-btn text-xs px-2 py-1 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition mr-2">View Tracker</button>
                        <button data-role="${roleName}" class="delete-role-btn text-xs px-2 py-1 bg-red-500 text-white rounded-lg hover:bg-red-600 transition">Delete</button>
                    </div>
                `;
                rolesStatusContainerEl.appendChild(card);
            });
            
            rolesStatusContainerEl.querySelectorAll('.view-role-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const role = e.target.dataset.role;
                    navigateTo('skills');
                    setActiveSkillsView(slugify(role));
                });
            });
            rolesStatusContainerEl.querySelectorAll('.delete-role-btn').forEach(btn => {
                btn.addEventListener('click', (e) => deleteRole(e.target.dataset.role));
            });
        }
        
        // Helper function to render company difficulty segments
        function renderCompanySegment(title, companies, color) {
            if (companies.length === 0) return '';
            const companyList = companies.map(c => `<span class="inline-block bg-${color}-100 text-${color}-800 text-xs font-medium px-2.5 py-0.5 rounded-full">${c}</span>`).join('');
            
            return `
                <div class="mb-3">
                    <h4 class="font-bold text-${color}-600 mb-2">${title} (${companies.length} of 10)</h4>
                    <div class="flex flex-wrap gap-2">${companyList}</div>
                </div>
            `;
        }


        /** Renders the Preparation steps and new structured data for all roles. */
        function renderPreparationPage() {
            const roles = Object.keys(trackedRolesData);
            prepContainerEl.innerHTML = '';

            if (roles.length === 0) {
                prepPlaceholderEl.classList.remove('hidden');
                return;
            }
            prepPlaceholderEl.classList.add('hidden');

            roles.forEach(roleName => {
                const data = trackedRolesData[roleName];
                const prepSteps = data.preparation.sort((a, b) => a.priority - b.priority);

                const roleCard = document.createElement('div');
                roleCard.className = 'p-6 card border-l-4 border-indigo-500 space-y-6';
                roleCard.innerHTML = `<h3 class="text-xl font-bold text-indigo-800 mb-4">${roleName} Preparation Plan</h3>`;

                // 1. Role Description
                roleCard.innerHTML += `
                    <div>
                        <h4 class="text-lg font-semibold text-gray-800 border-b pb-1 mb-2">Role Overview</h4>
                        <p class="text-gray-700">${data.roleDescription || 'No detailed description available.'}</p>
                    </div>
                `;

                // 2. Company Difficulty Matrix
                const companyHtml = `
                    <div>
                        <h4 class="text-lg font-semibold text-gray-800 border-b pb-1 mb-3">Target Company Difficulty (10 Placement)</h4>
                        ${renderCompanySegment('Easy (Practice)', data.easyCompanies, 'green')}
                        ${renderCompanySegment('Medium (Competitive)', data.mediumCompanies, 'yellow')}
                        ${renderCompanySegment('Hard (Top-Tier)', data.hardCompanies, 'red')}
                    </div>
                `;
                roleCard.innerHTML += companyHtml;


                // 3. Structured Preparation (Interview Rounds)
                let stepsHtml = '';
                if (prepSteps.length > 0) {
                    stepsHtml = `
                        <div>
                            <h4 class="text-lg font-semibold text-gray-800 border-b pb-1 mb-3">Interview & Readiness Rounds</h4>
                            <div class="space-y-4">
                                ${prepSteps.map(step => `
                                    <div class="p-3 bg-yellow-50 rounded-lg border border-yellow-200">
                                        <h4 class="font-semibold text-yellow-800">Priority ${step.priority}: ${step.step}</h4>
                                        <p class="text-sm text-yellow-700 mt-1">${step.details}</p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
                roleCard.innerHTML += stepsHtml;
                
                // 4. Reference Sites
                let referenceHtml = '';
                if (data.referenceSites.length > 0) {
                    referenceHtml = `
                        <div>
                            <h4 class="text-lg font-semibold text-gray-800 border-b pb-1 mb-3">Key Reference Sites</h4>
                            <ul class="list-disc ml-5 space-y-1 text-blue-600">
                                ${data.referenceSites.map(ref => `
                                    <li><a href="${ref.url}" target="_blank" class="hover:underline">${ref.name}</a></li>
                                `).join('')}
                            </ul>
                        </div>
                    `;
                }
                roleCard.innerHTML += referenceHtml;


                prepContainerEl.appendChild(roleCard);
            });

            if (prepContainerEl.innerHTML === '') {
                 prepPlaceholderEl.classList.remove('hidden');
            }
        }
        
        // --- SKILLS TRACKER RENDERING ---

        /** Sets the active view (collective or role-specific) on the Skills page. */
        function setActiveSkillsView(viewId) {
            activeSkillsView = viewId;
            
            // Update sub-navigation buttons
            skillsSubNavEl.querySelectorAll('.sub-nav-tab').forEach(btn => {
                btn.classList.remove('active', 'bg-indigo-500', 'text-white', 'shadow');
                btn.classList.add('bg-gray-100', 'text-gray-700');
                if (btn.dataset.view === viewId) {
                    btn.classList.add('active', 'bg-indigo-500', 'text-white', 'shadow');
                    btn.classList.remove('bg-gray-100', 'text-gray-700');
                }
            });

            // Update content visibility
            collectiveSkillsViewEl.classList.toggle('hidden', viewId !== 'collective');
            roleChecklistsViewsEl.querySelectorAll('.role-checklist-view').forEach(view => {
                view.classList.toggle('hidden', view.id !== `${viewId}-view`);
            });
            
            // Scroll to top of skills content
            document.getElementById('skills-page').scrollIntoView({ behavior: 'smooth' });
        }

        /** Renders a single checklist item with the editable time field. */
        function renderChecklistItem(item, index, type, roleName) {
            const roleSlug = slugify(roleName);
            const timeEstimate = item.targetTimeHours > 0 ? `${item.targetTimeHours} hrs` : 'N/A';
            
            const itemEl = document.createElement('div');
            itemEl.className = 'flex items-start p-3 bg-gray-50 rounded-lg shadow-sm hover:bg-gray-100 transition';
            
            const checkboxId = `${roleSlug}-${type}-${index}`;
            const timeInputId = `${roleSlug}-${type}-time-${index}`;
            
            itemEl.innerHTML = `
                <input id="${checkboxId}" type="checkbox" ${item.completed ? 'checked' : ''} class="mt-1 w-5 h-5 text-indigo-600 bg-gray-100 border-gray-300 rounded focus:ring-indigo-500 focus:border-indigo-500 cursor-pointer">
                <label for="${checkboxId}" class="ml-3 flex-1">
                    <p class="text-gray-900 font-medium ${item.completed ? 'line-through text-gray-500' : ''}">${item.item}</p>
                    <div class="flex items-center space-x-2 mt-1">
                        <label for="${timeInputId}" class="text-xs text-indigo-500 font-mono">Time (hrs):</label>
                        <input type="number" id="${timeInputId}" value="${item.targetTimeHours}" min="0" class="w-16 p-0.5 text-xs border border-gray-300 rounded focus:ring-indigo-500 focus:border-indigo-500 text-center">
                    </div>
                </label>
            `;

            // Completion Toggle
            const checkbox = itemEl.querySelector(`#${checkboxId}`);
            checkbox.addEventListener('change', (e) => {
                updateChecklistItem(roleName, type, index, 'completed', e.target.checked);
            });
            
            // Time Edit
            const timeInput = itemEl.querySelector(`#${timeInputId}`);
            timeInput.addEventListener('change', (e) => {
                updateChecklistItem(roleName, type, index, 'targetTimeHours', e.target.value);
            });

            return itemEl;
        }

        /** Renders the collective skills map. */
        function renderCollectiveSkills(rolesData) {
            const allSkills = {}; // { skillName: { roles: [], completed: bool }, ... }

            Object.keys(rolesData).forEach(roleName => {
                const data = rolesData[roleName];
                (data.skills || []).forEach(skill => {
                    const skillText = skill.item.trim();
                    if (!allSkills[skillText]) {
                        allSkills[skillText] = {
                            roles: [],
                            completed: false, 
                        };
                    }
                    if (!allSkills[skillText].roles.includes(roleName)) {
                        allSkills[skillText].roles.push(roleName);
                    }
                    // If any instance is completed, mark the collective skill as completed
                    if (skill.completed) {
                        allSkills[skillText].completed = true;
                    }
                });
            });

            collectiveSkillsListEl.innerHTML = '';
            const uniqueSkills = Object.keys(allSkills).sort();

            if (uniqueSkills.length === 0) {
                 collectiveSkillsListEl.innerHTML = `<p class="text-center text-gray-500 py-4">Tracked skills will appear here once roles are generated.</p>`;
                 return;
            }

            uniqueSkills.forEach(skillText => {
                const skillData = allSkills[skillText];
                
                const itemEl = document.createElement('div');
                itemEl.className = 'p-3 bg-gray-50 rounded-lg shadow-sm hover:bg-gray-100 transition flex items-start';
                
                const checkboxId = `collective-${slugify(skillText)}`;
                
                itemEl.innerHTML = `
                    <input id="${checkboxId}" type="checkbox" ${skillData.completed ? 'checked' : ''} class="mt-1 w-5 h-5 text-indigo-600 bg-gray-100 border-gray-300 rounded focus:ring-indigo-500 cursor-pointer">
                    <label for="${checkboxId}" class="ml-3 flex-1">
                        <p class="text-gray-900 font-medium ${skillData.completed ? 'line-through text-gray-500' : ''}">${skillText}</p>
                        <p class="text-xs text-green-600 font-medium mt-1">Required by: ${skillData.roles.join(', ')}</p>
                    </label>
                `;
                
                // Collective Completion Toggle: Must update ALL instances of this skill across ALL roles
                const checkbox = itemEl.querySelector(`#${checkboxId}`);
                checkbox.addEventListener('change', async (e) => {
                    const isCompleted = e.target.checked;
                    
                    // Iterate through all roles that require this skill
                    for (const roleName of skillData.roles) {
                        const roleData = trackedRolesData[roleName];
                        if (roleData) {
                            const updatedSkills = (roleData.skills || []).map(skill => {
                                if (skill.item.trim() === skillText) {
                                    return { ...skill, completed: isCompleted };
                                }
                                return skill;
                            });
                            
                            // Perform update for each role document
                            await updateDoc(getRoleDocRef(roleName), { skills: updatedSkills });
                        }
                    }
                });
                collectiveSkillsListEl.appendChild(itemEl);
            });
        }

        /** Renders the Skills page (Sub-navigation and all views). */
        function renderSkillsPage() {
            const roles = Object.keys(trackedRolesData);
            
            // 1. Handle empty state
            if (roles.length === 0) {
                skillsPlaceholderEl.classList.remove('hidden');
                skillsSubNavEl.innerHTML = `<button class="sub-nav-tab active" data-view="collective">Collective Skills (All Roles)</button>`;
                roleChecklistsViewsEl.innerHTML = '';
                return;
            }
            skillsPlaceholderEl.classList.add('hidden');

            // 2. Render Sub-Navigation (Collective + Role Tabs)
            skillsSubNavEl.innerHTML = '';
            
            const collectiveBtn = document.createElement('button');
            collectiveBtn.className = 'sub-nav-tab';
            collectiveBtn.dataset.view = 'collective';
            collectiveBtn.textContent = 'Collective Skills (All Roles)';
            collectiveBtn.addEventListener('click', () => setActiveSkillsView('collective'));
            skillsSubNavEl.appendChild(collectiveBtn);

            roles.forEach(roleName => {
                const roleSlug = slugify(roleName);
                const roleBtn = document.createElement('button');
                roleBtn.className = 'sub-nav-tab';
                roleBtn.dataset.view = roleSlug;
                roleBtn.textContent = roleName;
                roleBtn.addEventListener('click', () => setActiveSkillsView(roleSlug));
                skillsSubNavEl.appendChild(roleBtn);
            });

            // 3. Render Collective View
            renderCollectiveSkills(trackedRolesData);
            
            // 4. Render Individual Role Checklists
            roleChecklistsViewsEl.innerHTML = '';
            roles.forEach(roleName => {
                const data = trackedRolesData[roleName];
                const roleSlug = slugify(roleName);
                
                const roleView = document.createElement('div');
                roleView.id = `${roleSlug}-view`;
                roleView.className = 'role-checklist-view space-y-8 hidden';
                
                roleView.innerHTML = `
                    <h2 class="text-3xl font-bold text-gray-800 text-center">Tracker for: <span class="text-indigo-600">${roleName}</span></h2>
                    
                    <div class="card p-6">
                        <h3 class="text-xl font-semibold mb-4 text-indigo-700 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 mr-2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            Core Skills Checklist
                        </h3>
                        <div id="${roleSlug}-skills-list" class="space-y-4"></div>
                    </div>

                    <div class="card p-6">
                        <h3 class="text-xl font-semibold mb-4 text-indigo-700 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 mr-2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                            </svg>
                            Actionable Projects & Tasks
                        </h3>
                        <div id="${roleSlug}-tracker-list" class="space-y-4"></div>
                    </div>
                `;
                
                const skillsListEl = roleView.querySelector(`#${roleSlug}-skills-list`);
                (data.skills || []).forEach((item, index) => {
                    skillsListEl.appendChild(renderChecklistItem(item, index, 'skills', roleName));
                });
                
                const trackerListEl = roleView.querySelector(`#${roleSlug}-tracker-list`);
                (data.tracker || []).forEach((item, index) => {
                    trackerListEl.appendChild(renderChecklistItem(item, index, 'tracker', roleName));
                });

                roleChecklistsViewsEl.appendChild(roleView);
            });
            
            // 5. Activate the current view (or the first role if none is active)
            const viewToActivate = roles.includes(activeSkillsView) ? activeSkillsView : slugify(roles[0]) || 'collective';
            setActiveSkillsView(viewToActivate);
        }
        
        /** Renders the consolidated and breakdown metrics. */
        function renderMetricsPage() {
            const roles = Object.keys(trackedRolesData);
            metricsRoleBreakdownEl.innerHTML = '';

            if (roles.length === 0) {
                metricsDashboardEl.classList.add('hidden');
                metricsPlaceholderEl.classList.remove('hidden');
                metricsRoleBreakdownEl.innerHTML = `<p id="breakdown-placeholder" class="text-gray-500">Individual role metrics will show here.</p>`;
                return;
            }

            metricsPlaceholderEl.classList.add('hidden');
            metricsDashboardEl.classList.remove('hidden');
            
            let grandTotalTime = 0;
            let grandCompletedTime = 0;
            let grandTotalItems = 0;
            let grandCompletedItems = 0;

            roles.forEach(roleName => {
                const data = trackedRolesData[roleName];
                const progress = calculateProgress(data);
                
                grandTotalTime += progress.totalTime;
                grandCompletedTime += progress.completedTime;
                grandTotalItems += progress.totalItems;
                grandCompletedItems += progress.completedItems;

                // Render Breakdown Card
                const breakdownCard = document.createElement('div');
                breakdownCard.className = 'p-4 bg-gray-50 rounded-lg border border-gray-200';
                breakdownCard.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <p class="font-bold text-gray-800">${roleName} (${progress.percentage}%)</p>
                        <p class="text-sm text-indigo-500">${progress.completedItems} / ${progress.totalItems} items</p>
                    </div>
                    <div class="bg-gray-200 rounded-full h-2.5">
                        <div class="progress-bar bg-indigo-500 h-2.5 rounded-full" style="width: ${progress.percentage}%"></div>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">Time spent/target: ${progress.completedTime} / ${progress.totalTime} hrs</p>
                `;
                metricsRoleBreakdownEl.appendChild(breakdownCard);
            });

            // Calculate Grand Total Percentage (Weighted by time)
            const grandPercentage = grandTotalTime > 0 ? Math.round((grandCompletedTime / grandTotalTime) * 100) : 0;

            // 1. Overall Completion (Ring)
            metricsProgressTextEl.textContent = `${grandPercentage}%`;
            const circumference = 2 * Math.PI * 32; // 201px for r=32
            const offset = circumference - (grandPercentage / 100) * circumference;
            progressCircleEl.style.strokeDashoffset = offset;
            
            // 2. Total Learning Commitment
            metricsTotalTimeEl.textContent = `${grandTotalTime} hrs`;
            
            // 3. Items Completed
            metricsCompletedItemsEl.textContent = `${grandCompletedItems} / ${grandTotalItems}`;
        }

        // --- INPUT CHANGE & MAIN ACTION HANDLERS ---
        
        /** Populates the role select based on the active category. */
        function populateRoleSelect() {
            roleSelectEl.innerHTML = '<option value="" disabled selected>--- Select a Role ---</option>';
            (roleData[activeCategory] || []).forEach(role => {
                const option = document.createElement('option');
                option.value = role;
                option.textContent = role;
                roleSelectEl.appendChild(option);
            });
            updateGenerateButtonState();
        }

        function updateGenerateButtonState() {
            const selectedRole = roleSelectEl.value;
            const newRole = newRoleInputEl.value.trim();
            generateBtn.disabled = !(selectedRole || newRole);
        }
        
        // Category button click handler
        roleCategoriesEl.querySelectorAll('.category-button').forEach(btn => {
            btn.addEventListener('click', (e) => {
                roleCategoriesEl.querySelectorAll('.category-button').forEach(b => {
                    b.classList.remove('active', 'bg-indigo-500', 'text-white');
                    b.classList.add('bg-gray-100', 'text-gray-700');
                });
                e.target.classList.add('active', 'bg-indigo-500', 'text-white');
                e.target.classList.remove('bg-gray-100', 'text-gray-700');
                activeCategory = e.target.dataset.category;
                populateRoleSelect();
                newRoleInputEl.value = ''; // Clear custom input on category switch
                updateGenerateButtonState();
            });
        });

        roleSelectEl.addEventListener('change', updateGenerateButtonState);
        newRoleInputEl.addEventListener('input', updateGenerateButtonState);
        manualJDInputEl.addEventListener('input', updateGenerateButtonState); // Listening to JD input as well

        // Main button handler
        generateBtn.addEventListener('click', async () => {
            const selectedRole = roleSelectEl.value;
            const newRole = newRoleInputEl.value.trim();
            const manualJD = manualJDInputEl.value.trim(); // Get manual JD input
            const roleToUse = newRole || selectedRole;

            if (!roleToUse) return;

            if (trackedRolesData[roleToUse]) {
                showAlert(`The role "${roleToUse}" is already being tracked! View it on the Skills tab.`);
                navigateTo('roles');
                return;
            }

            if (!isAuthReady || !db) {
                showAlert('Authentication is not ready. Please wait a moment and try again.');
                return;
            }
            
            // Clear input fields
            newRoleInputEl.value = '';
            manualJDInputEl.value = ''; // Clear JD input
            roleSelectEl.value = '';
            updateGenerateButtonState();

            // Check for existing document using the slug (robust check)
            const docRef = getRoleDocRef(roleToUse);
            const docSnap = await getDoc(docRef); 

            if (docSnap.exists()) {
                console.log("Data found for this role. Displaying saved progress.");
                // onSnapshot handles rendering, just navigate to show it
            } else {
                console.log("No data found for this role. Generating new checklists via AI...");
                await generateChecklists(roleToUse, activeCategory, manualJD); // Pass manual JD
            }
            navigateTo('roles'); 
        });

        // Initialize view and button state
        window.onload = () => {
             populateRoleSelect();
             navigateTo('roles');
        }
    </script>
</body>
</html>
